"use strict";var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports, "__esModule", { value: true });exports.default = void 0;var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _OAuthClient = _interopRequireDefault(require("./OAuthClient"));
var _OAuthAuthorizationCode = _interopRequireDefault(require("./OAuthAuthorizationCode"));
var _OAuthToken = _interopRequireDefault(require("./OAuthToken"));
var _OAuthUser = _interopRequireDefault(require("./OAuthUser"));
var _jsonwebtoken = _interopRequireDefault(require("jsonwebtoken"));
var _ip = _interopRequireDefault(require("ip"));

const getAccessToken = /*#__PURE__*/function () {var _ref = (0, _asyncToGenerator2.default)(function* (bearerToken) {
    const oathToken = yield _OAuthToken.default.findOne({
      accessToken: bearerToken }).
    lean();

    return oathToken;
  });return function getAccessToken(_x) {return _ref.apply(this, arguments);};}();

const getRefreshToken = /*#__PURE__*/function () {var _ref2 = (0, _asyncToGenerator2.default)(function* (refreshToken) {
    let token = yield _OAuthToken.default.findOne({
      refreshToken: refreshToken }).
    lean();

    return token;
  });return function getRefreshToken(_x2) {return _ref2.apply(this, arguments);};}();

const getAuthorizationCode = /*#__PURE__*/function () {var _ref3 = (0, _asyncToGenerator2.default)(function* (authorizationCode) {
    const authCode = yield _OAuthAuthorizationCode.default.findOne({
      authorizationCode }).

    populate("client").
    populate("user").
    lean();

    return authCode;
  });return function getAuthorizationCode(_x3) {return _ref3.apply(this, arguments);};}();

const getClient = /*#__PURE__*/function () {var _ref4 = (0, _asyncToGenerator2.default)(function* (clientId, clientSecret) {
    const oathClient = yield _OAuthClient.default.findOne({
      clientId: clientId,
      clientSecret: clientSecret }).
    lean();

    return oathClient;
  });return function getClient(_x4, _x5) {return _ref4.apply(this, arguments);};}();

const getUser = /*#__PURE__*/function () {var _ref5 = (0, _asyncToGenerator2.default)(function* (_id) {
    const user = yield _OAuthUser.default.findOne({
      _id }).
    lean();

    return user;
  });return function getUser(_x6) {return _ref5.apply(this, arguments);};}();

const saveToken = /*#__PURE__*/function () {var _ref6 = (0, _asyncToGenerator2.default)(function* (token, client, user) {
    const accessToken = new _OAuthToken.default({
      accessToken: token.accessToken,
      accessTokenExpiresAt: token.accessTokenExpiresAt,
      client: client,
      clientId: client.clientId,
      refreshToken: token.refreshToken,
      refreshTokenExpiresAt: token.refreshTokenExpiresAt,
      user: user,
      userId: user._id });


    // Can't just chain `lean()` to `save()` as we did with `findOne()` elsewhere. Instead we use `Promise` to resolve the data.
    let saveResult = yield accessToken.save();

    let expirationTime = parseInt(token.accessTokenExpiresAt.getTime() / 1000); // expiration time, seconds since unix epoch

    const accessJWT = _jsonwebtoken.default.sign(
    {
      sub: user._id, // subject, whom the token refers to
      oauthId: user.oauthId,
      // event_id: '',
      token_use: "access",
      scope: user.role,
      auth_time: parseInt(new Date().getTime() / 1000), // time when authetication occurred
      // TODO: change this to actuall origin it's running on
      iss: _ip.default.address(), // issuer, who created and signed this token
      exp: expirationTime,
      jti: saveResult._id, // jwt id unique identifier for this token
      client_id: clearInterval.clientId,
      username: user.username,
      phoneNumber: user.phoneNumber,
      didAddress: user.didAddress,
      didPublicEncryptionKey: user.didPublicEncryptionKey },

    process.env.AUTH_SECRET);


    saveResult.accessToken = accessJWT;
    saveResult = yield accessToken.save();

    // `saveResult` is mongoose wrapper object, not doc itself. Calling `toJSON()` returns the doc.
    saveResult =
    saveResult && typeof saveResult == "object" ?
    saveResult.toJSON() :
    saveResult;

    // Unsure what else points to `saveResult` in oauth2-server, making copy to be safe
    const data = new Object();
    for (const prop in saveResult) data[prop] = saveResult[prop];
    // /oauth-server/lib/models/token-model.js complains if missing `client` and `user`. Creating missing properties.
    data.client = data.clientId;
    data.user = data.userId;

    return data;
  });return function saveToken(_x7, _x8, _x9) {return _ref6.apply(this, arguments);};}();

const saveAuthorizationCode = /*#__PURE__*/function () {var _ref7 = (0, _asyncToGenerator2.default)(function* (code, client, user) {
    const authCode = new _OAuthAuthorizationCode.default({
      authorizationCode: code.authorizationCode,
      expiresAt: code.expiresAt,
      redirectUri: code.redirectUri,
      // scope: code.scope, // you can use this to specify permissions
      clientId: client.clientId,
      userId: user._id });

    const clientSaved = yield getClient(client.clientId, client.clientSecret);
    const userSaved = yield getUser(user._id);
    authCode.client = clientSaved;
    authCode.user = userSaved;

    let saveResult = yield authCode.save();
    saveResult =
    saveResult && typeof saveResult == "object" ?
    saveResult.toJSON() :
    saveResult;
    const data = new Object();
    for (const prop in saveResult) data[prop] = saveResult[prop];

    return data;
  });return function saveAuthorizationCode(_x10, _x11, _x12) {return _ref7.apply(this, arguments);};}();

const revokeAuthorizationCode = /*#__PURE__*/function () {var _ref8 = (0, _asyncToGenerator2.default)(function* (code) {
    yield _OAuthAuthorizationCode.default.deleteMany({
      authorizationCode: code.authorizationCode });

    return true;
  });return function revokeAuthorizationCode(_x13) {return _ref8.apply(this, arguments);};}();var _default =

{
  getAccessToken,
  getRefreshToken,
  getAuthorizationCode,
  getClient,
  getUser,
  saveToken,
  saveAuthorizationCode,
  revokeAuthorizationCode };exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kYXRhYmFzZS9tb2RlbHMvT2F1dGguanMiXSwibmFtZXMiOlsiZ2V0QWNjZXNzVG9rZW4iLCJiZWFyZXJUb2tlbiIsIm9hdGhUb2tlbiIsIk9BdXRoVG9rZW5zTW9kZWwiLCJmaW5kT25lIiwiYWNjZXNzVG9rZW4iLCJsZWFuIiwiZ2V0UmVmcmVzaFRva2VuIiwicmVmcmVzaFRva2VuIiwidG9rZW4iLCJnZXRBdXRob3JpemF0aW9uQ29kZSIsImF1dGhvcml6YXRpb25Db2RlIiwiYXV0aENvZGUiLCJPQXV0aEF1dGhvcml6YXRpb25Db2Rlc01vZGVsIiwicG9wdWxhdGUiLCJnZXRDbGllbnQiLCJjbGllbnRJZCIsImNsaWVudFNlY3JldCIsIm9hdGhDbGllbnQiLCJPQXV0aENsaWVudHNNb2RlbCIsImdldFVzZXIiLCJfaWQiLCJ1c2VyIiwiT0F1dGhVc2Vyc01vZGVsIiwic2F2ZVRva2VuIiwiY2xpZW50IiwiYWNjZXNzVG9rZW5FeHBpcmVzQXQiLCJyZWZyZXNoVG9rZW5FeHBpcmVzQXQiLCJ1c2VySWQiLCJzYXZlUmVzdWx0Iiwic2F2ZSIsImV4cGlyYXRpb25UaW1lIiwicGFyc2VJbnQiLCJnZXRUaW1lIiwiYWNjZXNzSldUIiwiand0Iiwic2lnbiIsInN1YiIsIm9hdXRoSWQiLCJ0b2tlbl91c2UiLCJzY29wZSIsInJvbGUiLCJhdXRoX3RpbWUiLCJEYXRlIiwiaXNzIiwiaXAiLCJhZGRyZXNzIiwiZXhwIiwianRpIiwiY2xpZW50X2lkIiwiY2xlYXJJbnRlcnZhbCIsInVzZXJuYW1lIiwicGhvbmVOdW1iZXIiLCJkaWRBZGRyZXNzIiwiZGlkUHVibGljRW5jcnlwdGlvbktleSIsInByb2Nlc3MiLCJlbnYiLCJBVVRIX1NFQ1JFVCIsInRvSlNPTiIsImRhdGEiLCJPYmplY3QiLCJwcm9wIiwic2F2ZUF1dGhvcml6YXRpb25Db2RlIiwiY29kZSIsImV4cGlyZXNBdCIsInJlZGlyZWN0VXJpIiwiY2xpZW50U2F2ZWQiLCJ1c2Vy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NkIsTUFBWCxFQURKO0FBRUk3QixJQUFBQSxVQUhOO0FBSUEsVUFBTThCLElBQUksR0FBRyxJQUFJQyxNQUFKLEVBQWI7QUFDQSxTQUFLLE1BQU1DLElBQVgsSUFBbUJoQyxVQUFuQixFQUErQjhCLElBQUksQ0FBQ0UsSUFBRCxDQUFKLEdBQWFoQyxVQUFVLENBQUNnQyxJQUFELENBQXZCOztBQUUvQixXQUFPRixJQUFQO0FBQ0QsR0F2QjBCLGtCQUFyQkcscUJBQXFCLDZEQUEzQjs7QUF5QkEsTUFBTU0sdUJBQXVCLHlFQUFHLFdBQU9MLElBQVAsRUFBZ0I7QUFDOUMsVUFBTWxELGdDQUE2QndELFVBQTdCLENBQXdDO0FBQzVDMUQsTUFBQUEsaUJBQWlCLEVBQUVvRCxJQUFJLENBQUNwRCxpQkFEb0IsRUFBeEMsQ0FBTjs7QUFHQSxXQUFPLElBQVA7QUFDRCxHQUw0QixrQkFBdkJ5RCx1QkFBdUIsaURBQTdCLEM7O0FBT2U7QUFDYnBFLEVBQUFBLGNBRGE7QUFFYk8sRUFBQUEsZUFGYTtBQUdiRyxFQUFBQSxvQkFIYTtBQUliSyxFQUFBQSxTQUphO0FBS2JLLEVBQUFBLE9BTGE7QUFNYkksRUFBQUEsU0FOYTtBQU9ic0MsRUFBQUEscUJBUGE7QUFRYk0sRUFBQUEsdUJBUmEsRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBPQXV0aENsaWVudHNNb2RlbCBmcm9tIFwiLi9PQXV0aENsaWVudFwiO1xuaW1wb3J0IE9BdXRoQXV0aG9yaXphdGlvbkNvZGVzTW9kZWwgZnJvbSBcIi4vT0F1dGhBdXRob3JpemF0aW9uQ29kZVwiO1xuaW1wb3J0IE9BdXRoVG9rZW5zTW9kZWwgZnJvbSBcIi4vT0F1dGhUb2tlblwiO1xuaW1wb3J0IE9BdXRoVXNlcnNNb2RlbCBmcm9tIFwiLi9PQXV0aFVzZXJcIjtcbmltcG9ydCBqd3QgZnJvbSBcImpzb253ZWJ0b2tlblwiO1xuaW1wb3J0IGlwIGZyb20gXCJpcFwiO1xuXG5jb25zdCBnZXRBY2Nlc3NUb2tlbiA9IGFzeW5jIChiZWFyZXJUb2tlbikgPT4ge1xuICBjb25zdCBvYXRoVG9rZW4gPSBhd2FpdCBPQXV0aFRva2Vuc01vZGVsLmZpbmRPbmUoe1xuICAgIGFjY2Vzc1Rva2VuOiBiZWFyZXJUb2tlbixcbiAgfSkubGVhbigpO1xuXG4gIHJldHVybiBvYXRoVG9rZW47XG59O1xuXG5jb25zdCBnZXRSZWZyZXNoVG9rZW4gPSBhc3luYyAocmVmcmVzaFRva2VuKSA9PiB7XG4gIGxldCB0b2tlbiA9IGF3YWl0IE9BdXRoVG9rZW5zTW9kZWwuZmluZE9uZSh7XG4gICAgcmVmcmVzaFRva2VuOiByZWZyZXNoVG9rZW4sXG4gIH0pLmxlYW4oKTtcblxuICByZXR1cm4gdG9rZW47XG59O1xuXG5jb25zdCBnZXRBdXRob3JpemF0aW9uQ29kZSA9IGFzeW5jIChhdXRob3JpemF0aW9uQ29kZSkgPT4ge1xuICBjb25zdCBhdXRoQ29kZSA9IGF3YWl0IE9BdXRoQXV0aG9yaXphdGlvbkNvZGVzTW9kZWwuZmluZE9uZSh7XG4gICAgYXV0aG9yaXphdGlvbkNvZGUsXG4gIH0pXG4gICAgLnBvcHVsYXRlKFwiY2xpZW50XCIpXG4gICAgLnBvcHVsYXRlKFwidXNlclwiKVxuICAgIC5sZWFuKCk7XG5cbiAgcmV0dXJuIGF1dGhDb2RlO1xufTtcblxuY29uc3QgZ2V0Q2xpZW50ID0gYXN5bmMgKGNsaWVudElkLCBjbGllbnRTZWNyZXQpID0+IHtcbiAgY29uc3Qgb2F0aENsaWVudCA9IGF3YWl0IE9BdXRoQ2xpZW50c01vZGVsLmZpbmRPbmUoe1xuICAgIGNsaWVudElkOiBjbGllbnRJZCxcbiAgICBjbGllbnRTZWNyZXQ6IGNsaWVudFNlY3JldCxcbiAgfSkubGVhbigpO1xuXG4gIHJldHVybiBvYXRoQ2xpZW50O1xufTtcblxuY29uc3QgZ2V0VXNlciA9IGFzeW5jIChfaWQpID0+IHtcbiAgY29uc3QgdXNlciA9IGF3YWl0IE9BdXRoVXNlcnNNb2RlbC5maW5kT25lKHtcbiAgICBfaWQsXG4gIH0pLmxlYW4oKTtcblxuICByZXR1cm4gdXNlcjtcbn07XG5cbmNvbnN0IHNhdmVUb2tlbiA9IGFzeW5jICh0b2tlbiwgY2xpZW50LCB1c2VyKSA9PiB7XG4gIGNvbnN0IGFjY2Vzc1Rva2VuID0gbmV3IE9BdXRoVG9rZW5zTW9kZWwoe1xuICAgIGFjY2Vzc1Rva2VuOiB0b2tlbi5hY2Nlc3NUb2tlbixcbiAgICBhY2Nlc3NUb2tlbkV4cGlyZXNBdDogdG9rZW4uYWNjZXNzVG9rZW5FeHBpcmVzQXQsXG4gICAgY2xpZW50OiBjbGllbnQsXG4gICAgY2xpZW50SWQ6IGNsaWVudC5jbGllbnRJZCxcbiAgICByZWZyZXNoVG9rZW46IHRva2VuLnJlZnJlc2hUb2tlbixcbiAgICByZWZyZXNoVG9rZW5FeHBpcmVzQXQ6IHRva2VuLnJlZnJlc2hUb2tlbkV4cGlyZXNBdCxcbiAgICB1c2VyOiB1c2VyLFxuICAgIHVzZXJJZDogdXNlci5faWQsXG4gIH0pO1xuXG4gIC8vIENhbid0IGp1c3QgY2hhaW4gYGxlYW4oKWAgdG8gYHNhdmUoKWAgYXMgd2UgZGlkIHdpdGggYGZpbmRPbmUoKWAgZWxzZXdoZXJlLiBJbnN0ZWFkIHdlIHVzZSBgUHJvbWlzZWAgdG8gcmVzb2x2ZSB0aGUgZGF0YS5cbiAgbGV0IHNhdmVSZXN1bHQgPSBhd2FpdCBhY2Nlc3NUb2tlbi5zYXZlKCk7XG5cbiAgbGV0IGV4cGlyYXRpb25UaW1lID0gcGFyc2VJbnQodG9rZW4uYWNjZXNzVG9rZW5FeHBpcmVzQXQuZ2V0VGltZSgpIC8gMTAwMCk7IC8vIGV4cGlyYXRpb24gdGltZSwgc2Vjb25kcyBzaW5jZSB1bml4IGVwb2NoXG5cbiAgY29uc3QgYWNjZXNzSldUID0gand0LnNpZ24oXG4gICAge1xuICAgICAgc3ViOiB1c2VyLl9pZCwgLy8gc3ViamVjdCwgd2hvbSB0aGUgdG9rZW4gcmVmZXJzIHRvXG4gICAgICBvYXV0aElkOiB1c2VyLm9hdXRoSWQsXG4gICAgICAvLyBldmVudF9pZDogJycsXG4gICAgICB0b2tlbl91c2U6IFwiYWNjZXNzXCIsXG4gICAgICBzY29wZTogdXNlci5yb2xlLFxuICAgICAgYXV0aF90aW1lOiBwYXJzZUludChuZXcgRGF0ZSgpLmdldFRpbWUoKSAvIDEwMDApLCAvLyB0aW1lIHdoZW4gYXV0aGV0aWNhdGlvbiBvY2N1cnJlZFxuICAgICAgLy8gVE9ETzogY2hhbmdlIHRoaXMgdG8gYWN0dWFsbCBvcmlnaW4gaXQncyBydW5uaW5nIG9uXG4gICAgICBpc3M6IGlwLmFkZHJlc3MoKSwgLy8gaXNzdWVyLCB3aG8gY3JlYXRlZCBhbmQgc2lnbmVkIHRoaXMgdG9rZW5cbiAgICAgIGV4cDogZXhwaXJhdGlvblRpbWUsXG4gICAgICBqdGk6IHNhdmVSZXN1bHQuX2lkLCAvLyBqd3QgaWQgdW5pcXVlIGlkZW50aWZpZXIgZm9yIHRoaXMgdG9rZW5cbiAgICAgIGNsaWVudF9pZDogY2xlYXJJbnRlcnZhbC5jbGllbnRJZCxcbiAgICAgIHVzZXJuYW1lOiB1c2VyLnVzZXJuYW1lLFxuICAgICAgcGhvbmVOdW1iZXI6IHVzZXIucGhvbmVOdW1iZXIsXG4gICAgICBkaWRBZGRyZXNzOiB1c2VyLmRpZEFkZHJlc3MsXG4gICAgICBkaWRQdWJsaWNFbmNyeXB0aW9uS2V5OiB1c2VyLmRpZFB1YmxpY0VuY3J5cHRpb25LZXksXG4gICAgfSxcbiAgICBwcm9jZXNzLmVudi5BVVRIX1NFQ1JFVFxuICApO1xuXG4gIHNhdmVSZXN1bHQuYWNjZXNzVG9rZW4gPSBhY2Nlc3NKV1Q7XG4gIHNhdmVSZXN1bHQgPSBhd2FpdCBhY2Nlc3NUb2tlbi5zYXZlKCk7XG5cbiAgLy8gYHNhdmVSZXN1bHRgIGlzIG1vbmdvb3NlIHdyYXBwZXIgb2JqZWN0LCBub3QgZG9jIGl0c2VsZi4gQ2FsbGluZyBgdG9KU09OKClgIHJldHVybnMgdGhlIGRvYy5cbiAgc2F2ZVJlc3VsdCA9XG4gICAgc2F2ZVJlc3VsdCAmJiB0eXBlb2Ygc2F2ZVJlc3VsdCA9PSBcIm9iamVjdFwiXG4gICAgICA/IHNhdmVSZXN1bHQudG9KU09OKClcbiAgICAgIDogc2F2ZVJlc3VsdDtcblxuICAvLyBVbnN1cmUgd2hhdCBlbHNlIHBvaW50cyB0byBgc2F2ZVJlc3VsdGAgaW4gb2F1dGgyLXNlcnZlciwgbWFraW5nIGNvcHkgdG8gYmUgc2FmZVxuICBjb25zdCBkYXRhID0gbmV3IE9iamVjdCgpO1xuICBmb3IgKGNvbnN0IHByb3AgaW4gc2F2ZVJlc3VsdCkgZGF0YVtwcm9wXSA9IHNhdmVSZXN1bHRbcHJvcF07XG4gIC8vIC9vYXV0aC1zZXJ2ZXIvbGliL21vZGVscy90b2tlbi1tb2RlbC5qcyBjb21wbGFpbnMgaWYgbWlzc2luZyBgY2xpZW50YCBhbmQgYHVzZXJgLiBDcmVhdGluZyBtaXNzaW5nIHByb3BlcnRpZXMuXG4gIGRhdGEuY2xpZW50ID0gZGF0YS5jbGllbnRJZDtcbiAgZGF0YS51c2VyID0gZGF0YS51c2VySWQ7XG5cbiAgcmV0dXJuIGRhdGE7XG59O1xuXG5jb25zdCBzYXZlQXV0aG9yaXphdGlvbkNvZGUgPSBhc3luYyAoY29kZSwgY2xpZW50LCB1c2VyKSA9PiB7XG4gIGNvbnN0IGF1dGhDb2RlID0gbmV3IE9BdXRoQXV0aG9yaXphdGlvbkNvZGVzTW9kZWwoe1xuICAgIGF1dGhvcml6YXRpb25Db2RlOiBjb2RlLmF1dGhvcml6YXRpb25Db2RlLFxuICAgIGV4cGlyZXNBdDogY29kZS5leHBpcmVzQXQsXG4gICAgcmVkaXJlY3RVcmk6IGNvZGUucmVkaXJlY3RVcmksXG4gICAgLy8gc2NvcGU6IGNvZGUuc2NvcGUsIC8vIHlvdSBjYW4gdXNlIHRoaXMgdG8gc3BlY2lmeSBwZXJtaXNzaW9uc1xuICAgIGNsaWVudElkOiBjbGllbnQuY2xpZW50SWQsXG4gICAgdXNlcklkOiB1c2VyLl9pZCxcbiAgfSk7XG4gIGNvbnN0IGNsaWVudFNhdmVkID0gYXdhaXQgZ2V0Q2xpZW50KGNsaWVudC5jbGllbnRJZCwgY2xpZW50LmNsaWVudFNlY3JldCk7XG4gIGNvbnN0IHVzZXJTYXZlZCA9IGF3YWl0IGdldFVzZXIodXNlci5faWQpO1xuICBhdXRoQ29kZS5jbGllbnQgPSBjbGllbnRTYXZlZDtcbiAgYXV0aENvZGUudXNlciA9IHVzZXJTYXZlZDtcblxuICBsZXQgc2F2ZVJlc3VsdCA9IGF3YWl0IGF1dGhDb2RlLnNhdmUoKTtcbiAgc2F2ZVJlc3VsdCA9XG4gICAgc2F2ZVJlc3VsdCAmJiB0eXBlb2Ygc2F2ZVJlc3VsdCA9PSBcIm9iamVjdFwiXG4gICAgICA/IHNhdmVSZXN1bHQudG9KU09OKClcbiAgICAgIDogc2F2ZVJlc3VsdDtcbiAgY29uc3QgZGF0YSA9IG5ldyBPYmplY3QoKTtcbiAgZm9yIChjb25zdCBwcm9wIGluIHNhdmVSZXN1bHQpIGRhdGFbcHJvcF0gPSBzYXZlUmVzdWx0W3Byb3BdO1xuXG4gIHJldHVybiBkYXRhO1xufTtcblxuY29uc3QgcmV2b2tlQXV0aG9yaXphdGlvbkNvZGUgPSBhc3luYyAoY29kZSkgPT4ge1xuICBhd2FpdCBPQXV0aEF1dGhvcml6YXRpb25Db2Rlc01vZGVsLmRlbGV0ZU1hbnkoe1xuICAgIGF1dGhvcml6YXRpb25Db2RlOiBjb2RlLmF1dGhvcml6YXRpb25Db2RlLFxuICB9KTtcbiAgcmV0dXJuIHRydWU7XG59O1xuXG5leHBvcnQgZGVmYXVsdCB7XG4gIGdldEFjY2Vzc1Rva2VuLFxuICBnZXRSZWZyZXNoVG9rZW4sXG4gIGdldEF1dGhvcml6YXRpb25Db2RlLFxuICBnZXRDbGllbnQsXG4gIGdldFVzZXIsXG4gIHNhdmVUb2tlbixcbiAgc2F2ZUF1dGhvcml6YXRpb25Db2RlLFxuICByZXZva2VBdXRob3JpemF0aW9uQ29kZSxcbn07XG4iXX0=